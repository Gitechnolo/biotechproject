let performanceChart;async function loadJsPDF(){if(window.jspdf&&window.autoTable)return;const e=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.onload=t,n.onerror=()=>o(new Error(`Errore nel caricamento di ${e}`)),document.head.appendChild(n)}));try{await e("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"),await e("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js")}catch(e){throw e}}async function loadPerformanceData(){try{const e=await fetch("data/performance-latest.json");if(!e.ok)throw new Error("Dati non disponibili");const t=await e.json(),o=document.querySelector(".portfolio-row");if(!o)return;o.innerHTML="";const n=t.pages.find((e=>e.url.includes("/index.html")||"https://gitechnolo.github.io/biotechproject/"===e.url||e.url===window.location.origin+"/biotechproject/")),a=n?.generatedTime?new Date(n.generatedTime):new Date,r=document.getElementById("last-update");if(r){const e=a.toLocaleDateString("it-IT"),t=a.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});r.textContent=`Aggiornato il: ${e} alle ${t}`}const i=Math.round(t.pages.reduce(((e,t)=>e+(t.performanceScore||0)),0)/t.pages.length),c=i;aggiornaPerformanceScore(c);const s=document.createDocumentFragment();t.pages.forEach((e=>{const t=createPerformanceCard(e);s.appendChild(t)})),o.appendChild(s),filterSelection("all");const d=[];void 0!==n?.previousPerformanceScore&&null!==n.previousPerformanceScore&&d.push({date:subtractDays(a,5),score:n.previousPerformanceScore,note:"Misurazione precedente"}),d.push({date:formatDate(a),score:c,note:"Misurazione attuale"}),creaGrafico(d);const l=t.summary||{},p=l.averageAccessibility??94,m=l.averageSeo??96,u=l.averageBestPractices??97;document.querySelectorAll(".progress-circle").forEach((e=>{const t=e.dataset.metric,o={performance:i,"performance-desktop":Math.min(i+2,100),accessibility:p,seo:m,"best-practices":u}[t]||75,n=Math.round(o);e.style.setProperty("--value",`${n}%`),e.setAttribute("aria-valuenow",n),e.dataset.value=n}));const g=document.getElementById("last-updated");if(g&&t.lastUpdated){const e=new Date(t.lastUpdated);g.textContent=e.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric"})}const f=document.getElementById("trend-indicator");if(f&&n){const e=(n.performanceScore||0)-(n.previousPerformanceScore||0),t={1:"▲",0:"●","-1":"▼"},o=e>0?"#66bb6a":e<0?"#ef5350":"#ffa726";f.textContent=t[e>0?1:e<0?-1:0],f.style.color=o,f.classList.remove("visually-hidden")}const b=(e,t)=>{const o=document.getElementById(e);o&&(o.textContent=t)};if(b("analyzed-count",l.analyzed||t.pages.length),b("avg-performance",`${i}%`),b("avg-accessibility",`${p}%`),b("avg-seo",`${m}%`),b("avg-best-practices",`${u}%`),t.lastUpdated){const e=new Date(t.lastUpdated);b("last-updated-report",e.toLocaleDateString("it-IT")),document.getElementById("last-updated-report")?.setAttribute("datetime",e.toISOString())}document.body.classList.add("portfolio-loaded")}catch(e){aggiornaPerformanceScore(85),creaGrafico();const t=document.getElementById("last-update");t&&(t.textContent="Aggiornato il: dati non disponibili"),showNotification("Dati temporaneamente non disponibili. Mostrati valori di esempio."),document.body.classList.add("portfolio-loaded")}}function createPerformanceCard(e){const t=void 0!==e.performanceScore?e.performanceScore:void 0!==e.performance?Math.round(100*e.performance):85;let o="needs-improvement";o=t>=90?"optimized":t>=80?"compatible":t>=60?"needs-improvement":"deprecated";const n=(e.url||"Pagina sconosciuta").split("/").pop()||"index.html",a=e.loadTime?(e.loadTime/1e3).toFixed(1):"?",r=`tooltip-${sanitizeId(n)}`,i=`\n    <span class="status-badge badge-${o}">\n      ${o.replace("needs-improvement","Needs Improvement").replace("deprecated","Deprecated").replace("compatible","Compatible").replace("optimized","Optimized")}\n    </span>\n  `,c=document.createElement("div");c.className=`portfolio-col ${o} portfolio-show dynamic`,c.dataset.page=e.slug||n,c.innerHTML=`\n    <div class="portfolio-content">\n      <div \n        class="fadebox" \n        tabindex="0" \n        role="button"\n        aria-describedby="${r}"\n        aria-label="Mostra dettagli prestazioni per ${n}"\n      >\n        <strong>${n}${i}</strong><br>\n        Score: ${t}/100 \n        <span class="status-badge ${getTrendColorClass(t,e.previousPerformanceScore)}" \n              style="font-size: 9px; padding: 1px 5px; margin-left: 6px;">\n          ${getTrendArrow(t,e.previousPerformanceScore)}\n          ${null!==e.previousPerformanceScore&&void 0!==e.previousPerformanceScore?(t>e.previousPerformanceScore?"+":"")+(t-e.previousPerformanceScore):""}\n        </span>\n        • ${a} s\n        <div \n          id="${r}" \n          class="trend-details" \n          role="tooltip"\n        >\n          <div><strong>Punteggio:</strong> ${t}/100</div>\n          ${null!==e.previousPerformanceScore&&void 0!==e.previousPerformanceScore?`<div><strong>Precedente:</strong> ${e.previousPerformanceScore}</div>\n               <div><strong>Trend:</strong> ${getTrendArrow(t,e.previousPerformanceScore)}${t-e.previousPerformanceScore}</div>`:"<div><strong>Trend:</strong> Nessun dato precedente</div>"}\n          <div><strong>Tempo di caricamento:</strong> ${a} s</div>\n        </div>\n      </div>\n      <p class="greentext">${n} — ${o.charAt(0).toUpperCase()+o.slice(1)}</p>\n    </div>\n  `;const s=c.querySelector(".fadebox"),d=c.querySelector(".trend-details");return s.addEventListener("focus",(()=>{d.style.display="block"})),s.addEventListener("blur",(()=>{d.style.display="none"})),s.addEventListener("click",(()=>{const e="block"===d.style.display;d.style.display=e?"none":"block"})),s.addEventListener("keydown",(e=>{"Escape"===e.key&&(d.style.display="none",s.blur())})),c}function sanitizeId(e){return e.replace(/[^a-z0-9]/gi,"-").toLowerCase()}function setupRefreshButtons(){window.refreshButtonsSetup||(window.refreshButtonsSetup=!0,document.getElementById("refresh-btn")?.addEventListener("click",(async()=>{await loadPerformanceData(),showNotification("Dati aggiornati con successo")})),document.querySelectorAll(".refresh-btn").forEach((e=>{e.addEventListener("click",(async()=>{await loadPerformanceData(),showNotification("Dati aggiornati con successo")}))})))}function aggiornaPerformanceScore(e=85){const t=document.getElementById("performance-score")||document.getElementById("tech-maturity-score");t&&(t.textContent=`${e}%`);const o=document.getElementById("trend-indicator");if(o){const t=e-82;o.textContent=t>0?" ↑":t<0?" ↓":" →",o.style.color=t>0?"#10b981":t<0?"#ef4444":"#f59e0b",o.setAttribute("aria-label",t>0?"Trend in aumento":t<0?"Trend in diminuzione":"Trend stabile")}}function subtractDays(e,t){const o=new Date(e);return o.setDate(o.getDate()-t),formatDate(o)}function formatDate(e){const t=new Date(e),o=t.getDate(),n=t.toLocaleDateString("it-IT",{month:"short"}).replace(".",""),a=t.getFullYear();return a===(new Date).getFullYear()?`${o} ${n}`:`${o} ${n} '${a.toString().slice(-2)}`}const datiSimulati=[{date:"2024-09-01",score:30,note:"Avvio progetto"},{date:"2024-10-15",score:38,note:"Contenuti iniziali"},{date:"2024-12-01",score:45,note:"Versioni semplici"},{date:"2025-01-20",score:52,note:"Ottimizzazione mobile"},{date:"2025-03-10",score:60,note:"Accessibilità WCAG"},{date:"2025-05-05",score:70,note:"Forum integrato"},{date:"2025-07-01",score:78,note:"Dashboard attiva"},{date:"2025-09-15",score:85,note:"UI/UX coerente"}];function creaGrafico(e=[]){const t=document.getElementById("performance-trend");if(!t)return;const o=t.getContext("2d");performanceChart&&performanceChart.destroy();const n=e.length>0?e:datiSimulati,a=n.map((e=>e.date)),r=n.map((e=>e.score)),i=e.length;performanceChart=new Chart(o,{type:"line",data:{labels:a,datasets:[{label:"Maturità Tecnologica del Sito (%)",data:r,borderColor:"#10b981",backgroundColor:"rgba(16, 185, 129, 0.1)",borderWidth:3,pointRadius:e=>e.dataIndex===r.length-1?8:5,pointBackgroundColor:e=>e.dataIndex===r.length-1?"#4ade80":e.dataIndex<i?"#10b981":"#f59e0b",fill:!0,tension:.3}]},options:{responsive:!0,plugins:{legend:{labels:{color:"#ffffff"}},tooltip:{backgroundColor:"#1f2937",titleColor:"#ffffff",bodyColor:"#d1d5db",borderColor:"#4b5563",borderWidth:1,callbacks:{label:e=>{const t=e.dataIndex<i?" (reale)":" (stimato)",o=n[e.dataIndex]?.note||"";return`${e.parsed.y}%${t} - ${o}`}}}},scales:{x:{ticks:{color:"#b2dfdb"},grid:{color:"rgba(178, 223, 219, 0.1)"}},y:{min:0,max:100,ticks:{color:"#b2dfdb"},grid:{color:"rgba(178, 223, 219, 0.1)"}}}}}),aggiornaTabellaDati(n)}function aggiornaTabellaDati(e){const t=document.getElementById("chart-data-body");t&&(t.innerHTML="",e.forEach((e=>{const o=document.createElement("tr"),n=document.createElement("td"),a=document.createElement("td");n.textContent=e.date,a.textContent=`${e.score}%`,o.appendChild(n),o.appendChild(a),t.appendChild(o)})))}if(void 0===showNotification)function showNotification(e){const t=document.getElementById("notification");t&&(t.textContent=e,t.classList.add("show"),setTimeout((()=>{t.classList.remove("show")}),3e3))}function filterSelection(e){document.querySelectorAll(".filter-btn").forEach((t=>{t.classList.toggle("active",t.dataset.filter===e)}));const t=document.querySelectorAll(".portfolio-col");let o=0;t.forEach((t=>{"all"===e||t.classList.contains(e)?(t.style.display="flex",o++):t.style.display="none"}));const n=document.querySelector(".portfolio-row");if(!document.getElementById("filter-message")){const e=document.createElement("p");e.id="filter-message",e.style.color="#a0aec0",e.style.textAlign="center",e.style.fontStyle="italic",e.style.padding="20px",n.parentNode.insertBefore(e,n.nextSibling)}document.getElementById("filter-message").textContent=0===o?"Nessuna pagina trovata con questo stato di maturità.":""}function getTrendArrow(e,t){if(null==t)return"→";const o=e-t;return o>0?"▲":o<0?"▼":"→"}function getTrendColorClass(e,t){return null==t?"badge-needs-improvement":e>t?"badge-optimized":e<t?"badge-deprecated":"badge-compatible"}async function exportToPDF(){const e=document.getElementById("export-data-btn"),t=e?.textContent||"Esporta dati";try{e&&(e.disabled=!0,e.textContent="Esportazione in corso..."),await loadJsPDF();let o,n="data/performance-latest.json";try{const e=await fetch(n);if(!e.ok)throw new Error("relative-fail");o=await e.json()}catch(e){const t="/biotechproject/data/performance-latest.json",n=await fetch(t);o=await n.json()}const{jsPDF:a}=window.jspdf,r=new a({unit:"pt",format:"a4"}),i=40;let c=40;const s=r.internal.pageSize.getWidth(),d=64,l="Biotech Project - Performance Report",p=await new Promise((e=>{const t=new Image;t.crossOrigin="Anonymous",t.onload=()=>e(t),t.onerror=()=>e(null),t.src="https://gitechnolo.github.io/biotechproject/Biotech-file/images/favicon-biotech.png"}));p&&r.addImage(p,"PNG",i,c,d,d);const m=i+d+15;r.setFontSize(22),r.text(l,m,c+20),c+=d+10,r.setFontSize(10),r.text("Generato: "+(new Date).toLocaleString("it-IT"),i,c),c+=14,o&&o.summary&&(r.text(`Riepilogo: ${o.summary.analyzed||"-"} pagine analizzate`,i,c),c+=12,r.text(`Ultimo aggiornamento: ${o.lastUpdated||"-"}`,i,c),c+=18);const u=document.getElementById("performance-trend");if(u)try{const e=u.toDataURL("image/png"),t=s-2*i,o=Math.min(t,520),n=u.height/u.width*o;r.addImage(e,"PNG",i,c,o,n),c+=n+20}catch(e){}r.setFontSize(14),r.text("Dettaglio Pagine e Punteggi",i,c),c+=14;const g=(o&&o.pages?o.pages:[]).map((e=>{const t=e.performanceScore??Math.round(100*(e.performance??.85));return[e.label,`${t}%`,e.url]})),f=e=>e>=90?{bg:"#d4edda",text:"#155724"}:e>=80?{bg:"#fff3cd",text:"#856404"}:{bg:"#f8d7da",text:"#721c24"};r.autoTable({startY:c,head:[["Etichetta Pagina","Punteggio","URL"]],body:g,theme:"striped",headStyles:{fillColor:[39,174,96],textColor:255,fontSize:10},styles:{fontSize:9,cellPadding:3,valign:"middle"},columnStyles:{0:{cellWidth:150},1:{cellWidth:60,halign:"center"},2:{cellWidth:290}},didParseCell:e=>{if("body"===e.section&&1===e.column.index){const t=parseInt(e.cell.text[0].replace("%",""));if(!isNaN(t)){const o=f(t);e.cell.styles.fillColor=o.bg,e.cell.styles.textColor=o.text,e.cell.styles.fontStyle="bold"}}},didDrawPage:e=>{c=e.cursor.y,r.setFontSize(8),r.setTextColor(150),r.text(`Pagina ${e.pageNumber} di ${r.internal.pages.length-1}`,e.settings.margin.left,r.internal.pageSize.getHeight()-10)}}),c=r.autoTable.previous.finalY+12,c+20>r.internal.pageSize.getHeight()-40&&(r.addPage(),c=40),r.setFontSize(9),r.setTextColor(0),r.text("Dati estratti da performance-latest.json",i,c),r.save("biotech-performance-report.pdf")}catch(e){alert("Errore durante l'esportazione PDF. Controlla la console per dettagli.")}finally{e&&(e.disabled=!1,e.textContent=t)}}document.addEventListener("DOMContentLoaded",(()=>{setupRefreshButtons(),loadPerformanceData(),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>{filterSelection(e.dataset.filter)}))}));const e=document.getElementById("export-data-btn");e&&e.addEventListener("click",exportToPDF)}));