let performanceChart;async function loadJsPDF(){if(window.jspdf&&window.autoTable)return;const loadScript=(src)=>new Promise((resolve,reject)=>{const script=document.createElement('script');script.src=src;script.onload=resolve;script.onerror=()=>reject(new Error(`Errore nel caricamento di ${src}`));document.head.appendChild(script)});try{await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js')}catch(error){console.error(error.message);throw error}}
async function loadPerformanceData(){console.log('ðŸ”§ loadPerformanceData() in esecuzione');try{const response=await fetch('data/performance-latest.json');if(!response.ok)throw new Error('Dati non disponibili');const data=await response.json();const container=document.querySelector('.portfolio-row');if(!container)return;container.innerHTML='';const homePage=data.pages.find(p=>p.url.includes('/index.html')||p.url==='https://gitechnolo.github.io/biotechproject/'||p.url===window.location.origin+'/biotechproject/');const reportTime=homePage?.generatedTime?new Date(homePage.generatedTime):new Date();const lastUpdate=document.getElementById('last-update');if(lastUpdate){const dateStr=reportTime.toLocaleDateString('it-IT');const timeStr=reportTime.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});lastUpdate.textContent=`Aggiornato il: ${dateStr} alle ${timeStr}`}
const avgPerf=Math.round(data.pages.reduce((sum,p)=>sum+(p.performanceScore||0),0)/data.pages.length);const performanceScoreValue=avgPerf;aggiornaPerformanceScore(performanceScoreValue);const fragment=document.createDocumentFragment();data.pages.forEach(page=>{const card=createPerformanceCard(page);fragment.appendChild(card)});container.appendChild(fragment);filterSelection('all');const history=[];if(homePage?.previousPerformanceScore!==undefined&&homePage.previousPerformanceScore!==null){history.push({date:subtractDays(reportTime,5),score:homePage.previousPerformanceScore,note:'Misurazione precedente'})}
history.push({date:formatDate(reportTime),score:performanceScoreValue,note:'Misurazione attuale'});creaGrafico(history);const summary=data.summary||{};const avgA11y=summary.averageAccessibility??94;const avgSeo=summary.averageSeo??96;const avgBest=summary.averageBestPractices??97;document.querySelectorAll('.progress-circle').forEach(circle=>{const metric=circle.dataset.metric;const value={performance:avgPerf,'performance-desktop':Math.min(avgPerf+2,100),accessibility:avgA11y,seo:avgSeo,'best-practices':avgBest}[metric]||75;const rounded=Math.round(value);circle.style.setProperty('--value',`${rounded}%`);circle.setAttribute('aria-valuenow',rounded);circle.dataset.value=rounded});const trendEl=document.getElementById('trend-indicator');if(trendEl&&homePage){const diff=(homePage.performanceScore||0)-(homePage.previousPerformanceScore||0);const icons={1:'â–²',0:'â—','-1':'â–¼'};trendEl.classList.remove('trend-up','trend-down','trend-equal');const trendClass=diff>0?'trend-up':diff<0?'trend-down':'trend-equal';trendEl.classList.add(trendClass);trendEl.textContent=icons[diff>0?1:diff<0?-1:0];trendEl.classList.remove('visually-hidden')}
const update=(id,value)=>{const el=document.getElementById(id);if(el)el.textContent=value};update('analyzed-count',summary.analyzed||data.pages.length);update('avg-performance',`${avgPerf}%`);update('avg-accessibility',`${avgA11y}%`);update('avg-seo',`${avgSeo}%`);update('avg-best-practices',`${avgBest}%`);document.body.classList.add('portfolio-loaded')}catch(error){console.warn('âš ï¸ Impossibile caricare i dati reali:',error);aggiornaPerformanceScore(85);creaGrafico();document.body.classList.add('portfolio-loaded')}}
function createPerformanceCard(page){const performance=page.performanceScore!==undefined?page.performanceScore:Math.round((page.performance||0.85)*100);let perfClass='needs-improvement';if(performance>=90)perfClass='optimized';else if(performance>=80)perfClass='compatible';else if(performance>=60)perfClass='needs-improvement';else perfClass='deprecated';const url=page.url||'Pagina sconosciuta';const fileName=url.split('/').pop()||'index.html';const loadTime=page.loadTime?(page.loadTime/1000).toFixed(1):'?';const tooltipId=`tooltip-${sanitizeId(fileName)}`;const diff=performance-(page.previousPerformanceScore||performance);const trendClass=diff>0?'trend-up':diff<0?'trend-down':'trend-equal';const badgeHTML=`
    <span class="status-badge badge-${perfClass}">
      ${perfClass.replace('needs-improvement', 'Needs Improvement')
                 .replace('deprecated', 'Deprecated')
                 .replace('compatible', 'Compatible')
                 .replace('optimized', 'Optimized')}
    </span>
  `;const card=document.createElement('div');card.className=`portfolio-col ${perfClass} portfolio-show dynamic`;card.dataset.page=page.slug||fileName;card.innerHTML=`
    <div class="portfolio-content">
      <div class="fadebox" tabindex="0" role="button" aria-describedby="${tooltipId}">
        <strong>${fileName}${badgeHTML}</strong><br>
        Score: ${performance}/100 
        <span class="status-badge badge-trend ${trendClass}">
          ${getTrendArrow(performance, page.previousPerformanceScore)}
          ${page.previousPerformanceScore !== null && page.previousPerformanceScore !== undefined 
            ? (performance > page.previousPerformanceScore ? '+' : '') + (performance - page.previousPerformanceScore) 
            : ''}
        </span>
        â€¢ ${loadTime} s
        <div id="${tooltipId}" class="trend-details" role="tooltip">
          <div><strong>Punteggio:</strong> ${performance}/100</div>
          ${page.previousPerformanceScore !== null && page.previousPerformanceScore !== undefined 
            ? `<div><strong>Precedente:</strong>${page.previousPerformanceScore}</div><div><strong>Trend:</strong>${getTrendArrow(performance,page.previousPerformanceScore)}${performance-page.previousPerformanceScore}</div>`
            : `<div><strong>Trend:</strong>Nessun dato precedente</div>`}
          <div><strong>Tempo di caricamento:</strong> ${loadTime} s</div>
        </div>
      </div>
      <p class="greentext">${fileName} â€” ${perfClass.charAt(0).toUpperCase() + perfClass.slice(1)}</p>
    </div>
  `;const fadebox=card.querySelector('.fadebox');const trendDetails=card.querySelector('.trend-details');fadebox.addEventListener('focus',()=>trendDetails.style.display='block');fadebox.addEventListener('blur',()=>trendDetails.style.display='none');fadebox.addEventListener('click',()=>{const isDisplayed=trendDetails.style.display==='block';trendDetails.style.display=isDisplayed?'none':'block'});return card}
function sanitizeId(str){return str.replace(/[^a-z0-9]/gi,'-').toLowerCase()}
function setupRefreshButtons(){if(window.refreshButtonsSetup)return;window.refreshButtonsSetup=!0;document.querySelectorAll('.refresh-btn, #refresh-btn').forEach(btn=>{btn.addEventListener('click',async()=>{await loadPerformanceData();showNotification('Dati aggiornati')})})}
function aggiornaPerformanceScore(performanceScoreValue=85){const scoreEl=document.getElementById('performance-score')||document.getElementById('tech-maturity-score');if(scoreEl)scoreEl.textContent=`${performanceScoreValue}%`;const trendIndicator=document.getElementById('trend-indicator');if(trendIndicator){const trend=performanceScoreValue-82;trendIndicator.textContent=trend>0?' â†‘':trend<0?' â†“':' â†’';trendIndicator.classList.remove('trend-up','trend-down','trend-equal');const statusClass=trend>0?'trend-up':trend<0?'trend-down':'trend-equal';trendIndicator.classList.add(statusClass);trendIndicator.setAttribute('aria-label',trend>0?'Trend in aumento':trend<0?'Trend in diminuzione':'Trend stabile')}}
function subtractDays(date,days){const d=new Date(date);d.setDate(d.getDate()-days);return formatDate(d)}
function formatDate(date){const d=new Date(date);const options={month:'short'};const month=d.toLocaleDateString('it-IT',options).replace('.','');return `${d.getDate()} ${month}`}
function creaGrafico(history=[]){const ctx=document.getElementById('performance-trend');if(!ctx)return;const chartCtx=ctx.getContext('2d');if(performanceChart)performanceChart.destroy();const labels=history.map(d=>d.date);const values=history.map(d=>d.score);performanceChart=new Chart(chartCtx,{type:'line',data:{labels:labels,datasets:[{label:'MaturitÃ  Tecnologica (%)',data:values,borderColor:'#10b981',backgroundColor:'rgba(16, 185, 129, 0.1)',fill:!0,tension:0.3}]},options:{responsive:!0,scales:{y:{min:0,max:100}}}})}
function showNotification(message){const notification=document.getElementById('notification');if(notification){notification.textContent=message;notification.classList.add('show');setTimeout(()=>notification.classList.remove('show'),3000)}}
function filterSelection(filter){document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.toggle('active',btn.dataset.filter===filter)});const cards=document.querySelectorAll('.portfolio-col');cards.forEach(card=>{card.style.display=(filter==='all'||card.classList.contains(filter))?'flex':'none'})}
function getTrendArrow(current,previous){if(previous===undefined||previous===null)return'â†’';const diff=current-previous;return diff>0?'â–²':diff<0?'â–¼':'â†’'}
async function exportToPDF(){const btn=document.getElementById('export-data-btn');try{if(btn)btn.disabled=!0;await loadJsPDF();const{jsPDF}=window.jspdf;const doc=new jsPDF();doc.text("Biotech Report",10,10);doc.save('report.pdf')}finally{if(btn)btn.disabled=!1}}
document.addEventListener('DOMContentLoaded',()=>{setupRefreshButtons();loadPerformanceData();const exportBtn=document.getElementById('export-data-btn');if(exportBtn)exportBtn.addEventListener('click',exportToPDF);})